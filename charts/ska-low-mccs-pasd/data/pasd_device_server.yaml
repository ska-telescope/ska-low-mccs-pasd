{{- $pasd_device_servers := dict}}
{{- range $server_name, $this_server := .Values.deviceServers}}
{{- if $this_server}}
{{- $_ := set $pasd_device_servers $server_name $this_server}}
{{- end}}
{{- end}}
{{- if $pasd_device_servers}}
name: "pasd-{{.Release.Name}}"
function: ska-low-mccs-pasd
domain: ska-low-mccs-pasd
instances:
{{keys $pasd_device_servers | toYaml}}
command: pasd_device_server
server:
  name: pasd_device_server
  instances:
{{- range $server_key, $this_server := $pasd_device_servers}}
  - name: {{$server_key}}
{{- with $this_server.depends_on}}
    depends_on:
{{- toYaml . | nindent 4}}
{{- end}}
{{- with $this_server.expose}}
    exposeDS: {{.}}
{{- end}}
    classes:
{{- range $device_type, $device_spec := $this_server.devices}}
    - name: {{$device_type}}
      devices:
{{- range $device_trl, $this_device := $device_spec}}
{{- if $this_device}}
      - name: {{$device_trl}}
        properties:
{{- range $property_name, $property_value := $this_device}}
{{- if not (kindIs "slice" $property_value)}}
{{- $property_value = list $property_value}}
{{- end}}
        - name: {{$property_name | quote}}
          values:
{{- $property_value | toStrings | toYaml | nindent 10}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}
depends_on:
  - device: sys/database/2
image:
{{- with .Values.image}}
  registry: {{.registry | quote}}
  image: {{.name | quote}}
  tag: {{.tag | default $.Chart.AppVersion | quote}}
  pullPolicy: {{.pullPolicy | quote}}
{{- end}}
livenessProbe:
{{ toYaml .Values.livenessProbe | indent 2 }}
readinessProbe:
{{ toYaml .Values.readinessProbe | indent 2 }}
{{- end}}
